<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>[Homework] Lab 03</title>
    <script type="text/javascript" src="three.js"></script>
    <script type="text/javascript" src="stats.js"></script>
    <script type="text/javascript" src="dat.gui.js"></script>
    <script type="text/javascript" src="OrbitControls.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas id="webgl"></canvas>
    <div id="stats"></div>

    <script>
      // TODO - fix stairs side
      // TODO - add shadows
      // TODO - fix camera rotation
      // TODO - improve fence textures
      // TODO - add flowers and grass
      // TODO - add details in church (torches, candles, etc)
      // TODO - add light sources inside the church

      /*
       * CONSTANTS
       */
      const TEXTURES_DIR = "textures";
      const MOVEMENT_SPEED = 0.1;

      const CONTROLS = {
        w: "forward",
        ArrowUp: "forward",
        s: "backward",
        ArrowDown: "backward",
        d: "right",
        ArrowRight: "right",
        a: "left",
        ArrowLeft: "left",
        " ": "up",
        Control: "down",
      };

      const ACTIVE_CONTROLS = Object.fromEntries(
        Object.values(CONTROLS).map((key) => [key, false])
      );

      const CHURCH = {
        layers: [
          `
          r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r
          r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r
          r,r,r,r,t,t,t,r,r,r,r,r,r,r,r,r
          r,r,t,t,t,t,t,t,t,t,t,r,t,t,r,r
          r,r,t,t,t,t,t,t,t,t,t,t,t,t,t,r
          r,r,t,t,t,t,t,or,t,or,t,or,t,t,t,r
          r,r,t,t,t,or,or,or,or,or,or,or,or,or,t,r
          r,r,t,t,t,t,t,or,t,or,t,or,t,t,t,r
          r,r,t,t,t,t,t,t,t,t,t,t,t,t,t,r
          r,r,r,t,t,t,t,t,t,t,t,t,t,t,t,r
          r,r,r,r,t,t,t,r,r,r,r,r,w,w,r,r
          r,r,r,r,r,r,r,r,r,r,r,r,g,r,r,r
          r,r,r,r,r,r,r,r,r,r,r,r,g,g,r,r
          d,r,d,r,r,r,r,r,g,r,g,d,g,r,d,r
          d,r,d,r,r,r,d,g,g,d,g,r,g,d,r,r
          r,r,r,r,r,g,g,r,d,g,r,r,r,r,r,r
          `,
          `
          _,_,l,w,ws2,_,ws2,w,l,_,_,_,_,_,_,_
          _,l,l,w,w,ws2,w,w,l,w,l,bs2,bs2,w,_,_
          cs3,w,w,w,ah1,ah1,ah1,w,w,w,w,w,w,w,w,_
          _,w,ah1,ah1,ah1,ah1,ah1,_,_,_,_,w,_,_,w,w
          l,w,ah1,b,b,or,_,_,as3,_,as3,_,as3,_,as3,w
          l,w,ah1,b,b,or,_,_,as3,_,as3,_,as3,_,as3,w
          cs3,w,ah1,b,b,or,_,_,_,_,_,_,_,_,_,ws1
          _,w,ah1,b,b,or,_,_,as3,_,as3,_,_,_,as3,w
          l,w,ah1,b,b,or,_,_,as3,_,as3,_,_,_,as3,w
          l,w,w,ah1,a,a,ah1,_,_,_,_,w,_,_,w,w
          cs3,w,w,w,ah1,ah1,ah1,c,w,w,w,w,d0,d0,w,_
          _,l,l,w,w,w,w,w,l,w,l,bs1,_,_,bs3,_
          cs0,_,cs0,w,ws0,_,ws0,w,l,_,l,w,_,_,w,_
          _,_,_,l,l,_,l,_,_,_,_,_,_,_,_,l
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,l
          l,_,_,_,_,_,_,_,_,_,l,l,l,_,l,l
          `,
          `
          _,_,_,w,_,_,_,w,_,_,_,_,_,_,_,_
          _,_,l,ws3,w,sg0,w,ws1,l,w,l,_,_,w,_,_
          _,w,ws2,w,_,_,_,w,c,w,c,w,w,w,w,_
          _,cs3,w,_,_,_,_,_,_,_,_,w,_,_,w,w
          _,w,_,_,_,_,_,_,_,_,_,_,_,_,_,ws1
          _,cs3,_,_,ow,_,_,_,_,_,_,_,_,_,_,w
          _,w,_,_,ow,_,_,_,_,_,_,_,_,_,_,fg1
          _,cs3,_,_,ow,_,_,_,_,_,_,_,_,_,_,w
          l,w,_,_,_,_,_,_,_,_,_,_,_,_,_,ws1
          _,cs3,w,_,as0,as0,_,_,_,_,_,w,_,_,w,w
          _,w,ws0,w,_,_,_,w,w,w,w,w,_,_,w,_
          _,_,l,_,w,sg0,w,_,l,w,l,bf13,_,_,bf13,_
          _,_,_,w,_,_,l,w,_,_,_,w,_,_,w,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,l,_,_,_,l
          `,
          `
          _,_,_,w,_,_,_,w,_,_,_,_,_,_,_,_
          _,_,_,_,w,sg0,w,_,_,w,_,_,_,w,_,_
          _,w,_,w,_,_,_,w,w,c,w,w,w,w,w,_
          _,w,w,_,_,_,_,_,_,_,_,ws3,ws5,ws7,ws1,w
          _,sg1,_,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,w,_,_,_,_,_,_,_,_,_,_,_,_,_,w
          _,sg1,_,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,w,_,_,_,_,_,_,_,_,_,_,_,_,_,w
          _,sg1,_,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,w,w,_,_,_,_,_,_,_,_,ws3,ws5,ws7,ws1,w
          _,w,_,w,_,_,_,w,c,w,c,w,cs4,cs4,w,_
          _,_,_,_,w,sg0,w,_,_,w,_,_,_,_,_,_
          _,_,_,w,_,_,_,w,_,_,_,w,_,_,w,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,w,sg0,w,_,_,ws2,_,_,_,ws2,_,_
          _,w,_,w,_,_,_,w,w,c,c,w,w,w,c,_
          _,w,w,_,_,_,_,_,_,_,_,_,ws3,ws1,_,w
          _,w,_,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,cs7,bs1,_,_,_,_,_,_,_,_,_,_,_,_,w
          _,w,bs1,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,cs7,bs1,_,_,_,_,_,_,_,_,_,_,_,_,w
          _,w,_,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,w,w,_,_,_,_,_,_,_,_,_,ws3,ws1,_,w
          _,w,_,w,_,_,_,w,w,w,w,c,c,c,w,_
          _,_,_,_,w,sg0,w,_,_,ws0,_,bs3,cs5,cs7,bs1,_
          _,_,_,w,_,_,_,w,_,_,_,bs3,cs5,cs7,bs1,_
          _,_,_,_,_,_,_,_,_,_,_,bs3,bs5,bs7,bs1,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,ws7,w,sg0,w,ws5,_,_,_,_,_,_,_,_
          _,w,_,w,_,_,_,w,c,w,w,w,w,w,w,_
          _,w,w,_,_,_,_,_,_,_,_,_,_,w,_,w
          _,_,w,_,_,_,_,_,_,_,_,_,_,_,_,ws5
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,_,w
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,_,fg1
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,_,w
          _,_,w,_,_,_,_,_,_,_,_,_,_,_,_,ws5
          _,w,w,_,_,_,_,_,_,_,_,_,_,w,_,w
          _,w,_,w,_,_,_,w,w,w,c,w,w,w,w,_
          _,_,_,ws7,w,sg0,w,ws5,_,_,_,_,bs3,bs1,_,_
          _,_,_,bs0,bs0,bh0,bs0,bs0,_,_,_,_,bs3,bs1,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,bs3,bs1,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,w,ws2,ws2,ws2,w,_,_,_,_,_,_,_,_
          _,ws3,_,w,w,w,w,w,w,fg0,w,fg0,w,fg0,w,_
          _,_,w,_,_,_,_,_,_,_,_,_,_,w,w,_
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,ws2
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,ws5
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,ws0
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,_
          _,_,w,_,_,_,_,_,_,_,_,_,_,w,w,_
          _,ws3,_,w,w,w,w,w,w,fg0,w,fg0,w,fg0,w,_
          _,_,_,w,bs0,bs0,bs0,w,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,w,_,_,_,w,_,_,_,_,_,_,_,_
          _,ws3,_,w,w,fg0,w,w,w,fg0,w,fg0,w,fg0,w,_
          _,_,w,_,_,_,_,_,_,_,_,_,_,w,w,_
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,ws1
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,_,_,_,_,w,_
          _,_,w,_,_,_,_,_,_,_,_,_,_,w,w,_
          _,ws3,_,w,w,fg0,w,w,w,fg0,w,fg0,w,fg0,w,_
          _,_,_,w,_,_,_,w,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          bs2,bs2,_,bs2,bs2,_,bs2,bs2,bs2,bs2,bs2,bs2,bs2,_,bs2,bs2
          w,ws6,w,w,_,w,w,w,ws6,w,ws6,w,ws6,w,w,bs4
          _,_,w,_,_,_,_,_,_,_,db0,_,_,w,ws1,_
          _,_,sg1,_,_,_,_,_,_,_,db0,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,db0,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,w,_,_,_,w,w
          _,_,sg1,_,_,_,_,_,_,_,db0,_,_,_,w,_
          _,_,sg1,_,_,_,_,_,_,_,db0,_,_,_,w,_
          _,_,w,_,_,_,_,_,_,_,db0,_,_,w,ws1,_
          _,w,ws4,w,w,fg0,w,w,w,w,w,w,w,ws4,w,bs6
          bs0,bs0,_,bs0,bs0,_,bs0,bs0,bs0,bs0,bs0,bs0,bs0,_,bs0,bs0
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_  
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2
          bs4,w,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,w,bs4
          _,_,w,_,_,_,db0,_,_,_,_,_,_,_,ws1,_
          _,_,sg1,_,_,_,db0,_,_,_,_,_,_,_,w,_
          _,_,sg1,_,_,_,w,_,_,_,db,_,_,_,sg1,_
          _,_,sg1,_,_,_,db0,_,_,_,_,_,_,_,w,_
          _,_,w,_,_,_,db0,_,_,_,_,_,_,_,ws1,_
          bs6,w,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,w,bs6
          bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2
          bs4,w,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,b,bs4
          _,_,bs5,_,_,_,dbs2,_,_,_,_,_,_,_,bs7,_
          _,_,bs5,_,_,_,db,_,_,_,db,_,_,_,bs7,_
          _,_,bs5,_,_,_,dbs0,_,_,_,_,_,_,_,bs7,_
          bs6,w,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,b,bs6
          bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2
          bs4,w,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,bs4,ws1,bs4
          _,ws7,_,_,_,_,db,_,_,_,db,_,_,_,w,_
          bs6,w,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,bs6,ws1,bs6
          bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          bs2,bs2,w,cs2,w,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2,bs2
          bh0,w,w,w,w,w,w,w,w,w,w,w,w,w,w,bh0
          bs0,bs0,w,cs0,w,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0,bs0
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,w,_,w,_,_,_,_,_,_,_,_,_,_,_
          b,bh1,_,bf,_,bh1,bh1,bh1,bh1,bh1,bh1,bh1,bh1,bh1,bh1,b
          _,_,w,_,w,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,w,_,w,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,bf,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,w,_,w,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,w,bf02,w,_,_,_,_,_,_,_,_,_,_,_
          _,_,bf13,bf0123,bf13,_,_,_,_,_,_,_,_,_,_,_
          _,_,w,bf02,w,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,cs2,_,cs2,_,_,_,_,_,_,_,_,_,_,_
          _,cs3,w,ws2,w,cs1,_,_,_,_,_,_,_,_,_,_
          _,_,ws3,_,ws1,_,_,_,_,_,_,_,_,_,_,_
          _,cs3,w,ws0,w,cs1,_,_,_,_,_,_,_,_,_,_
          _,_,cs0,_,cs0,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,cs2,ws6,cs2,_,_,_,_,_,_,_,_,_,_,_
          _,_,ws7,_,ws5,_,_,_,_,_,_,_,_,_,_,_
          _,_,cs0,ws4,cs0,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,cs2,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,cs3,c,cs1,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,cs0,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,

          `
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,cf,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          _,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_
          `,
        ],
        objects: {
          r: (size, displayedFaces) => new DirtWithGrass(size, displayedFaces),
          d: (size, displayedFaces) => new Dirt(size, displayedFaces),
          w: (size, displayedFaces) => new WallStone(size, displayedFaces),
          c: (size, displayedFaces) => new CobbleStone(size, displayedFaces),
          b: (size, displayedFaces) => new Bark(size, displayedFaces),
          db: (size, displayedFaces) => new DarkBark(size, displayedFaces),
          a: (size, displayedFaces) => new Wood(size, displayedFaces),
          t: (size, displayedFaces) => new WoodenTiles(size, displayedFaces),
          g: (size, displayedFaces) => new Gravel(size, displayedFaces),
          or: (size, displayedFaces) => new Wool(size, displayedFaces, "red"),
          ow: (size, displayedFaces) => new Wool(size, displayedFaces, "white"),
          l: (size) => new Leaves(size),
          db0: (size, displayedFaces) => createObject(DarkBark, size, 0, 1),
          db1: (size, displayedFaces) => createObject(DarkBark, size, 1, 1),
          cs0: (size) => createObject(CobbleStoneStairs, size, 0),
          cs1: (size) => createObject(CobbleStoneStairs, size, 1),
          cs2: (size) => createObject(CobbleStoneStairs, size, 2),
          cs3: (size) => createObject(CobbleStoneStairs, size, 3),
          cs4: (size) => createObject(CobbleStoneStairs, size, 0, 2),
          cs5: (size) => createObject(CobbleStoneStairs, size, 1, 2),
          cs7: (size) => createObject(CobbleStoneStairs, size, 3, 2),
          ws0: (size) => createObject(WallStoneStairs, size, 0),
          ws1: (size) => createObject(WallStoneStairs, size, 1),
          ws2: (size) => createObject(WallStoneStairs, size, 2),
          ws3: (size) => createObject(WallStoneStairs, size, 3),
          ws4: (size) => createObject(WallStoneStairs, size, 0, 2),
          ws5: (size) => createObject(WallStoneStairs, size, 1, 2),
          ws6: (size) => createObject(WallStoneStairs, size, 2, 2),
          ws7: (size) => createObject(WallStoneStairs, size, 3, 2),
          bs0: (size) => createObject(BarkStairs, size, 0),
          bs1: (size) => createObject(BarkStairs, size, 1),
          bs2: (size) => createObject(BarkStairs, size, 2),
          bs3: (size) => createObject(BarkStairs, size, 3),
          bs4: (size) => createObject(BarkStairs, size, 0, 2),
          bs5: (size) => createObject(BarkStairs, size, 1, 2),
          bs6: (size) => createObject(BarkStairs, size, 2, 2),
          bs7: (size) => createObject(BarkStairs, size, 3, 2),
          as0: (size) => createObject(WoodStairs, size, 0),
          as3: (size) => createObject(WoodStairs, size, 3),
          dbs0: (size) => createObject(DarkBarkStairs, size, 0),
          dbs2: (size) => createObject(DarkBarkStairs, size, 2),
          bh0: (size, displayedFaces) =>
            new BarkHalf(size, displayedFaces, "top"),
          bh1: (size, displayedFaces) =>
            new BarkHalf(size, displayedFaces, "bottom"),
          ah0: (size, displayedFaces) =>
            new WoodHalf(size, displayedFaces, "top"),
          ah1: (size, displayedFaces) =>
            new WoodHalf(size, displayedFaces, "bottom"),
          sg0: (size) => createObject(StainedGlass, size, 0),
          sg1: (size) => createObject(StainedGlass, size, 1),
          fg0: (size) => createObject(FrostedGlass, size, 0),
          fg1: (size) => createObject(FrostedGlass, size, 1),
          d0: (size) => createObject(Door, size, 0),
          bf: (size) => new BarkFence(size),
          bf02: (size) => new BarkFence(size, [0, 2]),
          bf13: (size) => new BarkFence(size, [1, 3]),
          bf0123: (size) => new BarkFence(size, [0, 1, 2, 3]),
          cf: (size) => new CobbleStoneFence(size),
        },
        full: new Set([
          "r",
          "w",
          "c",
          "b",
          "g",
          "or",
          "ow",
          "db",
          "db0",
          "db1",
        ]),
      };

      /*
       * UTILS
       */
      const textureLoader = new THREE.TextureLoader();

      const loadTexture = (
        dirName,
        textureName,
        type,
        extension,
        repeat = [1, 1]
      ) => {
        const texture = textureLoader.load(
          `${TEXTURES_DIR}/${dirName}/${textureName}_${type}.${extension}`
        );
        texture.repeat.set(...repeat);
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        return texture;
      };

      const loadTextures = (dirName, textureName, skipped = [], repeat) =>
        Object.fromEntries(
          [
            ["ambientOcclusion", "jpg"],
            ["baseColor", "jpg"],
            ["height", "png"],
            ["normal", "jpg"],
            ["roughness", "jpg"],
            ["metallic", "jpg"],
          ]
            .filter(([type, _]) => !skipped.includes(type))
            .map(([type, extension]) => [
              type,
              loadTexture(dirName, textureName, type, extension, repeat),
            ])
        );

      const createObject = (
        Constructor,
        size,
        yRotation = 0,
        zRotation = 0
      ) => {
        const stairs = new Constructor(size);
        stairs.rotation.y = (yRotation * Math.PI) / 2;
        stairs.rotation.z = (zRotation * Math.PI) / 2;
        return stairs;
      };

      class Spotlight extends THREE.Group {
        #target = new THREE.Object3D();

        constructor(color, opacity = 1, angle = 0.1) {
          super();
          this.#createSpotlight(color, opacity, angle);
        }

        get target() {
          return this.#target;
        }

        set target(target) {
          if (this.#target?.type === "Object3D") scene.remove(this.#target);
          this.#target = target;
          this.spotlight.target = target;
        }

        lookAt(vector) {
          if (this.#target?.type !== "Object3D") {
            this.target = new THREE.Object3D();
            scene.add(this.target);
          }
          this.#target.position.set(vector.x, vector.y, vector.z);
        }

        showHelper() {
          scene.add(new THREE.SpotLightHelper(this.spotlight));
        }

        showCone(color, opacity, height, segments = 25) {
          const coneGroup = (this.coneGroup = new THREE.Group());
          const radius = 0.9 * height * Math.tan(this.spotlight.angle);
          const cone = (this.cone = new THREE.Mesh(
            new THREE.ConeGeometry(radius, height, segments, 1, true),
            new THREE.MeshLambertMaterial({
              opacity,
              color,
              transparent: true,
            })
          ));
          const { x, y, z } = this.spotlight.position;
          cone.position.set(x, -height / 2, z);
          coneGroup.position.set(x, y, z);
          coneGroup.add(cone);
          this.add(coneGroup);
        }

        #createSpotlight(color, opacity, angle) {
          const spotlight = (this.spotlight = new THREE.SpotLight(
            color,
            opacity
          ));
          spotlight.angle = angle;
          spotlight.penumbra = 0.7;
          spotlight.shadow.camera.near = 0.1;
          spotlight.shadow.camera.far = 100;
          spotlight.shadow.camera.fov = 60;
          spotlight.shadow.mapSize.width = 4096;
          spotlight.shadow.mapSize.height = 4096;
          spotlight.shadow.radius = 40;
          spotlight.shadow.blurSamples = 200;
          spotlight.castShadow = true;
          spotlight.shadow.camera.left = -100;
          spotlight.shadow.camera.right = 100;
          spotlight.shadow.camera.top = 100;
          spotlight.shadow.camera.bottom = -100;

          this.add(spotlight);
        }
      }

      /*
       * SETUP
       */
      // Canvas
      const canvas = document.getElementById("webgl");

      // Scene
      const scene = new THREE.Scene();

      // GUI
      const guiControls = {
        rotate: false,
      };

      const gui = new dat.GUI();
      gui.add(guiControls, "rotate");

      // Statistics
      const stats = new Stats();
      stats.setMode(0);
      stats.domElement.style.position = "absolute";
      stats.domElement.style.left = "0px";
      stats.domElement.style.top = "0px";
      document.getElementById("stats").appendChild(stats.domElement);

      // Helpers
      const axesHelper = new THREE.AxesHelper(25);
      scene.add(axesHelper);

      /*
       * SIZES
       */
      const SIZES = {
        window: {
          width: window.innerWidth,
          height: window.innerHeight,
        },
      };

      /*
       * TEXTURES
       */
      const TEXTURES = {
        dirt: loadTextures("dirt", "dirt", ["metallic"]),
        grass: loadTextures("grass", "grass", ["metallic"]),
        dirtSide: loadTextures("dirt_side", "dirt_side", ["metallic"]),
        gravel: loadTextures("gravel", "gravel", ["metallic"]),
        wood: loadTextures("wood", "wood", ["metallic"]),
        stone: loadTextures("stone", "stone", ["metallic"]),
        wallStone: loadTextures("wall_stone", "wall_stone", ["metallic"]),
        cobblestone: loadTextures("cobblestone", "cobblestone", ["metallic"]),
        bark: {
          default: loadTextures("bark", "bark", ["metallic"]),
          dark: loadTextures("bark", "bark_dark", ["metallic"]),
        },
        wool: {
          red: loadTextures("wool", "wool_red", ["metallic"]),
          white: loadTextures("wool", "wool_white", ["metallic"]),
        },
        tiles: {
          wooden: loadTextures("tiles_wooden", "tiles_wooden", ["metallic"]),
        },
        leaves: {
          texture: loadTextures("leaves", "leaves", ["metallic"]),
          alpha: loadTexture("leaves", "leaves", "transparency", "jpg"),
        },
        glass: {
          stained: {
            texture: loadTextures("glass_stained", "glass_stained"),
            alpha: loadTexture(
              "glass_stained",
              "glass_stained",
              "transparency",
              "jpg"
            ),
          },
          frosted: {
            texture: loadTextures("glass_frosted", "glass_frosted", [
              "metallic",
            ]),
            alpha: loadTexture(
              "glass_frosted",
              "glass_frosted",
              "transparency",
              "jpg"
            ),
          },
        },
        door: {
          front: loadTextures("door", "door_front", [], [1, 2]),
          side: loadTextures("door", "door_side", [], [1, 2]),
          top: loadTextures("door", "door_top", [], [1, 1]),
        },
        skybox: {
          top: loadTexture("skybox", "clouds", "top", "jpg"),
          bottom: loadTexture("skybox", "clouds", "bottom", "jpg"),
          left: loadTexture("skybox", "clouds", "left", "jpg"),
          right: loadTexture("skybox", "clouds", "right", "jpg"),
          front: loadTexture("skybox", "clouds", "front", "jpg"),
          back: loadTexture("skybox", "clouds", "back", "jpg"),
        },
      };

      /*
       * MATERIALS
       */
      const MATERIALS = {
        phong: {
          white: new THREE.MeshPhongMaterial({
            color: 0xffffff,
            side: THREE.DoubleSide,
          }),
        },
        cache: {},
      };

      /*
       * GEOMETRIES
       */
      const GEOMETRIES = {
        cache: {},
      };

      class StairsGeometry extends THREE.BufferGeometry {
        constructor(width, height, depth, stepsCount) {
          super();
          const vertices = this.#createVertices(
            width,
            height,
            depth,
            stepsCount
          );
          const joints = this.#joinVertices(stepsCount);
          const positions = joints
            .flatMap((ids) => ids.flatMap((id) => vertices[id]))
            .map((p) => p - 0.5);
          const uvs = this.#createUVs(vertices, joints, width, height, depth);

          this.setAttribute(
            "position",
            new THREE.Float32BufferAttribute(positions, 3)
          );
          this.setAttribute("uv", new THREE.Float32BufferAttribute(uvs, 2));
          this.computeVertexNormals();
        }

        #createVertices(width, height, depth, stepsCount) {
          const vertices = [];
          const stepHeight = height / stepsCount;
          const stepDepth = depth / stepsCount;

          for (let i = 0; i <= stepsCount; i++) {
            vertices.push([0, i * stepHeight, 0]);
            vertices.push([width, i * stepHeight, 0]);

            if (i < stepsCount) {
              vertices.push([0, i * stepHeight, depth - i * stepDepth]);
              vertices.push([width, i * stepHeight, depth - i * stepDepth]);
            }

            if (i > 0) {
              vertices.push([0, i * stepHeight, depth - (i - 1) * stepDepth]);
              vertices.push([
                width,
                i * stepHeight,
                depth - (i - 1) * stepDepth,
              ]);
            }
          }

          return vertices;
        }

        #joinVertices(stepsCount) {
          const joints = [];

          joints.push(
            [0, 1, 2],
            [2, 1, 3],
            [0, 4, 1],
            [1, 4, 5],
            [1, 5, 3],
            [3, 5, 9],
            [0, 2, 8],
            [0, 8, 4],
            [2, 3, 8],
            [3, 9, 8]
          );

          let i = 1;
          for (; i < stepsCount - 1; i++) {
            joints.push(
              this.#join3Vertices(i, 0, 6, 1),
              this.#join3Vertices(i, 1, 6, 7),
              this.#join3Vertices(i, 1, 7, 3),
              this.#join3Vertices(i, 3, 7, 11),
              this.#join3Vertices(i, 0, 2, 6),
              this.#join3Vertices(i, 2, 10, 6),
              this.#join3Vertices(i, 2, 3, 10),
              this.#join3Vertices(i, 3, 11, 10),
              this.#join3Vertices(i, 2, 4, 3),
              this.#join3Vertices(i, 3, 4, 5)
            );
          }

          joints.push(
            this.#join3Vertices(i, 0, 6, 1),
            this.#join3Vertices(i, 1, 6, 7),
            this.#join3Vertices(i, 1, 7, 3),
            this.#join3Vertices(i, 3, 7, 9),
            this.#join3Vertices(i, 0, 2, 6),
            this.#join3Vertices(i, 2, 8, 6),
            this.#join3Vertices(i, 2, 3, 8),
            this.#join3Vertices(i, 3, 9, 8),
            this.#join3Vertices(i, 2, 4, 3),
            this.#join3Vertices(i, 3, 4, 5),
            this.#join3Vertices(i, 6, 8, 7),
            this.#join3Vertices(i, 7, 8, 9)
          );

          return joints;
        }

        #join3Vertices(level, a, b, c) {
          return [6 * level + a - 2, 6 * level + b - 2, 6 * level + c - 2];
        }

        #createUVs(vertices, joints, width, height, depth) {
          const uvs = [];

          for (let i = 0; i < joints.length; i++) {
            const [v1, v2, v3] = joints[i].map((id) => vertices[id]);
            if (v1[0] === v2[0] && v2[0] === v3[0]) {
              uvs.push(v1[2] / depth, v1[1] / height);
              uvs.push(v2[2] / depth, v2[1] / height);
              uvs.push(v3[2] / depth, v3[1] / height);
            } else if (v1[1] === v2[1] && v2[1] === v3[1]) {
              uvs.push(v1[0] / width, v1[2] / depth);
              uvs.push(v2[0] / width, v2[2] / depth);
              uvs.push(v3[0] / width, v3[2] / depth);
            } else {
              uvs.push(v1[0] / width, v1[1] / height);
              uvs.push(v2[0] / width, v2[1] / height);
              uvs.push(v3[0] / width, v3[1] / height);
            }
          }

          return uvs;
        }
      }

      /*
       * OBJECTS
       */
      class ObjectWithTexture extends THREE.Mesh {
        constructor(geometry, materials) {
          super(geometry, materials);
        }

        static parseTextures(textures, displayedFaces) {
          let texturesArray = textures;
          if (!(textures instanceof Array))
            texturesArray = new Array(6).fill(0).map((_) => textures);
          return texturesArray.map((texture, idx) =>
            displayedFaces.includes(idx) ? texture : null
          );
        }

        static createMaterial(key, id, type, texture, settings) {
          const cacheKey = `${key}-${id}`;
          if (!MATERIALS.cache[cacheKey]) {
            const maps = {
              map: texture.baseColor,
              aoMap: texture.ambientOcclusion,
              displacementMap: texture.height,
              displacementScale: 0.1,
            };

            if (texture.metallnessMap) {
              maps.metallnessMap = texture.metallnessMap;
              maps.metalness = 0.5;
            }

            if (type === "standard") {
              maps.roughnessMap = texture.roughness;
              maps.roughness = 0.5;
              maps.displacementMap = texture.height;
              maps.displacementScale = 0.1;
              maps.normalMap = texture.normal;
            }

            Object.assign(maps, settings);

            let material;
            switch (type) {
              case "phong":
                material = new THREE.MeshPhongMaterial(maps);
                break;
              case "lambert":
                material = new THREE.MeshLambertMaterial(maps);
                break;
              case "standard":
              default:
                material = new THREE.MeshStandardMaterial(maps);
            }

            MATERIALS.cache[cacheKey] = material;
          }
          return MATERIALS.cache[cacheKey];
        }

        static createMaterials(key, type, textures, settings) {
          return textures.map(
            (texture, idx) =>
              texture &&
              ObjectWithTexture.createMaterial(
                key,
                idx,
                type,
                texture,
                settings[idx] || settings.all
              )
          );
        }
      }

      class Block extends ObjectWithTexture {
        constructor(
          key,
          size,
          textures,
          displayedFaces = [0, 1, 2, 3, 4, 5],
          segments = 64,
          materialType = "standard",
          materialSettings = {}
        ) {
          const width = size.width || size;
          const height = size.height || size;
          const depth = size.depth || size;

          const geometry = Block.#createGeometry(
            key,
            width,
            height,
            depth,
            segments
          );
          const materials = ObjectWithTexture.createMaterials(
            key,
            materialType,
            ObjectWithTexture.parseTextures(textures, displayedFaces),
            materialSettings
          );
          super(geometry, materials);
        }

        static #createGeometry(key, width, height, depth, segments) {
          const cacheKey = `${key}-${width}-${height}-${depth}-${segments}`;

          if (!GEOMETRIES.cache[cacheKey]) {
            const geometry = new THREE.BoxBufferGeometry(
              width,
              height,
              depth,
              segments,
              segments,
              segments
            );
            const uvs = geometry.attributes.uv.array;
            geometry.setAttribute("uv2", new THREE.BufferAttribute(uvs, 2));
            GEOMETRIES.cache[cacheKey] = geometry;
          }

          return GEOMETRIES.cache[cacheKey];
        }
      }

      class Stairs extends ObjectWithTexture {
        constructor(key, size, texture, materialSettings) {
          const geometry = new StairsGeometry(size, size, size, 2);
          const uvs = geometry.attributes.uv.array;
          const material = ObjectWithTexture.createMaterial(
            key,
            0,
            "standard",
            texture,
            materialSettings
          );
          super(geometry, material);
        }
      }

      class BlockHalf extends Block {
        constructor(
          key,
          size,
          textures,
          displayedFaces = [0, 1, 2, 3, 4, 5],
          side = "top"
        ) {
          if (side === "top" && !displayedFaces.includes(2))
            displayedFaces.push(2);
          else if (!displayedFaces.includes(3)) displayedFaces.push(3);

          super(
            key,
            {
              width: size,
              height: size / 2,
              depth: size,
            },
            textures,
            displayedFaces
          );

          if (side === "top") {
            this.position.y += size / 4;
          } else {
            this.position.y -= size / 4;
          }
        }
      }

      class Fence extends THREE.Group {
        constructor(key, size, texture, connectedSides = [], jointsCount = 2) {
          super();
          this.key = key;
          this.texture = texture;
          this.size = size;

          this.add(this.#createPal(1, size));

          for (let side of connectedSides) {
            const joints = this.#createJoints(size, jointsCount);
            joints.rotation.y = (Math.PI / 2) * side;
            this.add(joints);
          }
        }

        #createJoints(side, jointsCount) {
          const group = new THREE.Group();

          for (let i = 0; i < jointsCount; i++) {
            const joint = this.#createPal(0.5, 0.4 * this.size);
            joint.rotateZ(Math.PI / 2);
            joint.position.y = (i * this.size) / (jointsCount + 1);
            joint.position.x = 0.3 * this.size;
            group.add(joint);
          }

          group.position.y -= this.size / (jointsCount + 1) / 2;

          return group;
        }

        #createPal(scale, height) {
          return new Block(
            this.key,
            {
              width: (this.size * scale) / 5,
              height,
              depth: (this.size * scale) / 5,
            },
            this.texture,
            undefined,
            undefined,
            "standard",
            {
              all: {
                displacementScale: 0.05 * scale,
              },
              2: {
                displacementScale: 0,
              },
              3: {
                displacementScale: 0,
              },
            }
          );
        }
      }

      class Dirt extends Block {
        constructor(size, displayedFaces) {
          super("dirt", size, TEXTURES.dirt, displayedFaces);
        }
      }

      class Grass extends Block {
        constructor(size, displayedFaces) {
          super("grass", size, TEXTURES.grass, displayedFaces, 64, "standard", {
            displacementScale: 0.2,
          });
        }
      }

      class DirtWithGrass extends Block {
        constructor(size, displayedFaces) {
          super(
            "dirt-with-grass",
            size,
            [
              TEXTURES.dirtSide,
              TEXTURES.dirtSide,
              TEXTURES.grass,
              TEXTURES.dirt,
              TEXTURES.dirtSide,
              TEXTURES.dirtSide,
            ],
            displayedFaces,
            128,
            "standard",
            {
              2: {
                displacementScale: 0.25,
              },
            }
          );
        }
      }

      class Gravel extends Block {
        constructor(size, displayedFaces) {
          super("gravel", size, TEXTURES.gravel, displayedFaces);
        }
      }

      class Leaves extends Block {
        constructor(size, displayedFaces) {
          super(
            "leaves",
            size,
            TEXTURES.leaves.texture,
            displayedFaces,
            128,
            "standard",
            {
              all: {
                displacementScale: 0.15,
                transparent: true,
                alphaMap: TEXTURES.leaves.alpha,
              },
            }
          );
        }
      }

      class WallStone extends Block {
        constructor(size, displayedFaces) {
          super("wall-stone", size, TEXTURES.stone, displayedFaces);
        }
      }

      class CobbleStone extends Block {
        constructor(size, displayedFaces) {
          super("cobblestone", size, TEXTURES.cobblestone, displayedFaces);
        }
      }

      class Bark extends Block {
        constructor(size, displayedFaces) {
          super("bark-default", size, TEXTURES.bark.default, displayedFaces);
        }
      }

      class DarkBark extends Block {
        constructor(size, displayedFaces) {
          super("bark-dark", size, TEXTURES.bark.dark, displayedFaces);
        }
      }

      class Wood extends Block {
        constructor(size, displayedFaces) {
          super("wood", size, TEXTURES.wood, displayedFaces);
        }
      }

      class WoodenTiles extends Block {
        constructor(size, displayedFaces) {
          super("wooden-tiles", size, TEXTURES.tiles.wooden, displayedFaces);
        }
      }

      class Wool extends Block {
        constructor(size, displayedFaces, color = "red") {
          super(`$wool-${color}`, size, TEXTURES.wool[color], displayedFaces);
        }
      }

      class Glass extends Block {
        constructor(key, size, texture, settings) {
          super(
            key,
            {
              width: size,
              height: size,
              depth: size / 10,
            },
            texture,
            [4, 5],
            256,
            "standard",
            {
              all: {
                metalness: 0.2,
                displacementScale: 0.05,
                roughness: 0.5,
                transparent: true,
                ...settings,
              },
            }
          );
        }
      }

      class StainedGlass extends Glass {
        constructor(size) {
          super("stained-glass", size, TEXTURES.glass.stained.texture, {
            alphaMap: TEXTURES.glass.stained.alpha,
          });
        }
      }

      class FrostedGlass extends Glass {
        constructor(size) {
          super("frosted-glass", size, TEXTURES.glass.frosted.texture, {
            alphaMap: TEXTURES.glass.frosted.alpha,
          });
        }
      }

      class Door extends Block {
        constructor(size) {
          super("door", { width: size, height: 2 * size, depth: size / 5 }, [
            TEXTURES.door.side,
            TEXTURES.door.side,
            TEXTURES.door.top,
            TEXTURES.door.top,
            TEXTURES.door.front,
            TEXTURES.door.front,
          ]);
          this.position.y += size / 2;
        }
      }

      class BarkHalf extends BlockHalf {
        constructor(size, displayedFaces, side) {
          super("bark", size, TEXTURES.bark.default, displayedFaces, side);
        }
      }

      class WoodHalf extends BlockHalf {
        constructor(size, displayedFaces, side) {
          super("wood", size, TEXTURES.wood, displayedFaces, side);
        }
      }

      class WallStoneStairs extends Stairs {
        constructor(size) {
          super("wall-stone-stairs", size, TEXTURES.stone);
        }
      }

      class CobbleStoneStairs extends Stairs {
        constructor(size) {
          super("cobblestone-stairs", size, TEXTURES.cobblestone);
        }
      }

      class BarkStairs extends Stairs {
        constructor(size) {
          super("bark-stairs", size, TEXTURES.bark.default);
        }
      }

      class DarkBarkStairs extends Stairs {
        constructor(size) {
          super("dark-bark-stairs", size, TEXTURES.bark.dark);
        }
      }

      class WoodStairs extends Stairs {
        constructor(size) {
          super("wooden-stairs", size, TEXTURES.wood);
        }
      }

      class BarkFence extends Fence {
        constructor(size, connectedSides) {
          super("bark-fence", size, TEXTURES.bark.default, connectedSides);
        }
      }

      class CobbleStoneFence extends Fence {
        constructor(size, connectedSides) {
          super(
            "cobblestone-fence",
            size,
            TEXTURES.cobblestone,
            connectedSides
          );
        }
      }

      class Construction extends THREE.Group {
        constructor(data, blockSize) {
          super();
          this.data = data;
          this.parsedLayers = this.#parseLayers(data.layers);
          this.ySegments = data.layers.length;
          this.zSegments = this.parsedLayers[0].length;
          this.xSegments = this.parsedLayers[0][0].length;
          const layersGroup = this.#createLayers(data, blockSize);
          layersGroup.position.y += blockSize / 2;
          layersGroup.position.x -= ((this.xSegments - 1) * blockSize) / 2;
          layersGroup.position.z -= ((this.zSegments - 1) * blockSize) / 2;
          this.add(layersGroup);
        }

        #parseLayerText(text) {
          return text
            .split("\n")
            .map((row) => row.trim())
            .filter(Boolean)
            .map((row) => {
              let rowArray = row.split(",");
              if (!(rowArray instanceof Array)) rowArray = row.split("");
              return rowArray;
            });
        }

        #parseLayers(layers) {
          return layers.map((layer) =>
            layer instanceof Array ? layer : this.#parseLayerText(layer)
          );
        }

        #createLayers(data, blockSize) {
          const layersGroup = new THREE.Group();
          this.parsedLayers.map((layer, y) => {
            const layerGroup = new THREE.Group();
            layer.forEach((row, z) => {
              row.forEach((symbol, x) => {
                if (symbol === "_") return;
                const displayedFaces = this.#getDisplayedFaces(x, y, z);
                if (!displayedFaces.length) return;
                try {
                  const object = data.objects[symbol](
                    blockSize,
                    displayedFaces
                  );
                  const position = this.#getPosition(x, y, z, blockSize);
                  object.position.set(
                    position.x,
                    object.position.y + position.y,
                    position.z
                  );
                  layerGroup.add(object);
                } catch (e) {
                  console.error(`'${symbol}' is not recognized: ` + e);
                }
              });
              layersGroup.add(layerGroup);
            });
          });
          return layersGroup;
        }

        #getDisplayedFaces(x, y, z) {
          const displayedFaces = [];

          if (this.#isEmpty(x, y, z - 1)) displayedFaces.push(5); // back side
          if (this.#isEmpty(x, y, z + 1)) displayedFaces.push(4); // front side
          if (this.#isEmpty(x, y - 1, z)) displayedFaces.push(3); // bottom side
          if (this.#isEmpty(x, y + 1, z)) displayedFaces.push(2); // top side
          if (this.#isEmpty(x - 1, y, z)) displayedFaces.push(1); // left side
          if (this.#isEmpty(x + 1, y, z)) displayedFaces.push(0); // right side

          return displayedFaces;
        }

        #getPosition(x, y, z, blockSize) {
          return new THREE.Vector3(x * blockSize, y * blockSize, z * blockSize);
        }

        #isEmpty(x, y, z) {
          return (
            x < 0 ||
            x >= this.xSegments ||
            y < 0 ||
            y >= this.ySegments ||
            z < 0 ||
            z >= this.zSegments ||
            this.#isEmptySymbol(this.parsedLayers[y][z][x])
          );
        }

        #isEmptySymbol(symbol) {
          return symbol === "_" || !this.data.full.has(symbol);
        }
      }

      const church = new Construction(CHURCH, 1);
      scene.add(church);

      /*
       * SKYBOX
       */
      const skybox = new THREE.Mesh(
        new THREE.BoxGeometry(10000, 10000, 10000),
        ["right", "left", "top", "bottom", "front", "back"].map(
          (side) =>
            new THREE.MeshBasicMaterial({
              map: TEXTURES.skybox[side],
              side: THREE.BackSide,
            })
        )
      );
      scene.add(skybox);

      /*
       * LIGHTS
       */
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.75);
      scene.add(ambientLight);

      const spotLight = new Spotlight(0xffffff, 1, 0.1);
      spotLight.position.set(20, 40, 20);
      spotLight.lookAt(new THREE.Vector3(0, 10, 0));
      scene.add(spotLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff);
      directionalLight.position.set(10, 30, 20);
      scene.add(directionalLight);

      /*
       * CAMERA
       */
      const camera = new THREE.PerspectiveCamera(
        75,
        SIZES.window.width / SIZES.window.height,
        0.1,
        10000
      );
      camera.position.x = 14;
      camera.position.y = 12;
      camera.position.z = 12;
      camera.lookAt(new THREE.Vector3(0, 8, 0));

      // camera.position.x = 1;
      // camera.position.y = 1.5;
      // camera.position.z = 1;
      // camera.lookAt(new THREE.Vector3(0, 0, 0));
      scene.add(camera);

      // Controls
      const orbitControls = new THREE.OrbitControls(camera, canvas);
      orbitControls.enableDamping = true;

      /*
       * RENDERER
       */
      const renderer = new THREE.WebGLRenderer({
        canvas,
        antialias: true,
      });
      renderer.setClearColor(new THREE.Color(0xeeeeee));

      /*
       * EVENTS
       */
      // Event handlers
      const handleResize = () => {
        // Update window sizes
        const width = (SIZES.window.width = window.innerWidth);
        const height = (SIZES.window.height = window.innerHeight);

        // Update camera
        camera.aspect = width / height;
        camera.updateProjectionMatrix();

        // Update renderer
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      };

      const handleKeydown = ({ key }) => {
        if (!CONTROLS[key]) return;
        ACTIVE_CONTROLS[CONTROLS[key]] = true;
      };

      const handleKeyup = ({ key }) => {
        if (!CONTROLS[key]) return;
        ACTIVE_CONTROLS[CONTROLS[key]] = false;
      };

      const handleMovement = () => {
        let moveVector = null;
        if (ACTIVE_CONTROLS.forward)
          moveVector = new THREE.Vector3(0, 0, -MOVEMENT_SPEED);
        if (ACTIVE_CONTROLS.backward)
          moveVector = new THREE.Vector3(0, 0, MOVEMENT_SPEED);
        if (ACTIVE_CONTROLS.right)
          moveVector = new THREE.Vector3(MOVEMENT_SPEED, 0, 0);
        if (ACTIVE_CONTROLS.left)
          moveVector = new THREE.Vector3(-MOVEMENT_SPEED, 0, 0);
        if (ACTIVE_CONTROLS.up) {
          camera.position.y += MOVEMENT_SPEED;
        }
        if (ACTIVE_CONTROLS.down) {
          camera.position.y -= MOVEMENT_SPEED;
        }

        if (!moveVector) return;
        const rotationMatrix = new THREE.Matrix4();
        rotationMatrix.makeRotationFromEuler(camera.rotation);
        moveVector.applyMatrix4(rotationMatrix);
        camera.position.add(moveVector);
      };

      // Event listeners
      window.addEventListener("resize", handleResize);
      window.addEventListener("keydown", handleKeydown);
      window.addEventListener("keyup", handleKeyup);

      /*
       * ANIMATIONS
       */
      const update = () => {
        // Update stats
        stats.update();

        // Call animation functions
        if (guiControls.rotate) {
          church.rotation.y += 0.005;
        }
        // Move camera
        handleMovement();

        // Render the next frame
        renderer.render(scene, camera);

        // Request the new animation frame
        requestAnimationFrame(update);
      };

      /*
       * MAIN
       */
      handleResize();
      update();
    </script>
  </body>
</html>
